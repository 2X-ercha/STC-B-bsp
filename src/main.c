#include <STC15F2K60S2.H>

#include "bsp_global.h"
#include "callback.h"
#include "timer0.h"
#include "seg_led.h"
#include "button.h"
#include "sm.h"
#include "beep.h"
#include "uart.h"

#include <INTRINS.H>
// debug test fun
unsigned char ledtest = 0xf;
unsigned char leftbit = 0;
void waterled(){
    // led流水灯测试
    leftbit = (ledtest >> 7) & 1;
    ledtest <<= 1;
    ledtest |= leftbit;
    Led_Print(ledtest);
}
unsigned char hello[8] = {0x76, 0x79, 0x38, 0x38, 0x5c, 0, 0, 0};
unsigned char text[4] = {0xaa, 0x55, 0xaa, 0x55};
code char number[] = {0x3f,	0x06,	0x5b,	0x4f,	0x66,	0x6d,	0x7d,	0x07,	0x7f,	0x6f,};

code unsigned char testmusic[] = {
	0x27, 0x08, 0x26, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	
	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c,
	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08,
	0x31, 0x08,	0x32, 0x08, 0x27, 0x0c,	0x25, 0x0c, 0x23, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04, 0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x04, 0x32, 0x0c,	0x33, 0x04,
	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08, 0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	
	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x23, 0x10, 0x25, 0x10, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x31, 0x08,
	0x27, 0x08,	0x25, 0x04, 0x23, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x34, 0x25, 0x38, 0x00, 0x28, 0x26, 0x20, 0x26, 0x08,	0x25, 0x08, 0x26, 0x08, 0x27, 0x08, 0x26, 0x20, 0x26, 0x08,	
	0x25, 0x08, 0x26, 0x08, 0x27, 0x08, 0x31, 0x20, 0x31, 0x08, 0x32, 0x08, 0x31, 0x08, 0x27, 0x08, 0x31, 0x08,	0x27, 0x08, 0x26, 0x08, 0x33, 0x08, 0x31, 0x20, 0x26, 0x20, 0x26, 0x08,	0x25, 0x08,
	0x26, 0x08,	0x27, 0x08, 0x26, 0x20, 0x26, 0x08,	0x25, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x10,	0x24, 0x10, 0x27, 0x08,	0x26, 0x08, 0x25, 0x08,	0x26, 0x08, 0x25, 0x18,	0x24, 0x08, 0x24, 0x20,
	0x26, 0x08,	0x26, 0x04, 0x26, 0x08, 0x26, 0x04, 0x26, 0x10, 0x26, 0x08, 0x27, 0x08,	0x26, 0x08, 0x25, 0x10, 0x25, 0x08,	0x33, 0x04,	0x33, 0x1c, 0x33, 0x04,	0x33, 0x04, 0x33, 0x08,	0x32, 0x08,	
	0x31, 0x08,	0x27, 0x08, 0x32, 0x04,	0x31, 0x08,	0x27, 0x0c, 0x26, 0x08, 0x25, 0x0c,	0x25, 0x0c, 0x24, 0x08, 0x26, 0x20, 0x26, 0x08,	0x26, 0x04, 0x26, 0x08, 0x26, 0x04, 0x26, 0x10, 0x26, 0x08,
	0x27, 0x08,	0x27, 0x08, 0x27, 0x10,	0x27, 0x08,	0x25, 0x04,	0x25, 0x14, 0x00, 0x08,	0x25, 0x08, 0x24, 0x10, 0x24, 0x08,	0x23, 0x08, 0x24, 0x08,	0x25, 0x04, 0x26, 0x0c, 0x26, 0x08, 0x26, 0x18,
	0x25, 0x04,	0x24, 0x04, 0x25, 0x20, 0x33, 0x08,	0x00, 0x08, 0x33, 0x08,	0x00, 0x08, 0x33, 0x08, 0x27, 0x08, 0x26, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	
	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	
	0x32, 0x0c, 0x33, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c,
	0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x0c,	0x25, 0x0c, 0x23, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x04, 0x32, 0x0c,	0x33, 0x04, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	
	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x23, 0x10, 0x25, 0x10, 0x27, 0x08,	0x25, 0x04, 0x23, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x34, 0x25, 0x08,	0x26, 0x04,	0x26, 0x54, 0x26, 0x20, 0x26, 0x0c,	
	0x21, 0x0c, 0x23, 0x08, 0x26, 0x20, 0x26, 0x0c,	0x27, 0x0c, 0x31, 0x08, 0x27, 0x20, 0x27, 0x0c,	0x31, 0x0c, 0x32, 0x08, 0x33, 0x20, 0x33, 0x0c,	0x33, 0x0c, 0x34, 0x08, 0x33, 0x0c,	0x31, 0x0c,
	0x26, 0x08, 0x33, 0x0c,	0x31, 0x0c, 0x26, 0x08, 0x33, 0x0c,	0x31, 0x0c, 0x26, 0x08, 0x33, 0x0c,	0x31, 0x0c, 0x26, 0x08, 0x23, 0x40, 0x27, 0x20, 0x22, 0x20, 0x16, 0x0c,	0x21, 0x0c, 0x23, 0x08,
	0x16, 0x20, 0x26, 0x0c,	0x27, 0x0c, 0x31, 0x08, 0x27, 0x0c,	0x25, 0x0c, 0x22, 0x10, 0x25, 0x08, 0x27, 0x08,	0x31, 0x08, 0x33, 0x20,	0x33, 0x0c,	0x33, 0x0c, 0x34, 0x08, 0x33, 0x0c,	0x26, 0x0c,
	0x31, 0x08, 0x33, 0x0c,	0x32, 0x0c, 0x27, 0x08, 0x26, 0x18, 0x35, 0x08,	0x35, 0x08, 0x37, 0x08, 0x36, 0x08,	0x35, 0x08, 0x32, 0x08,	0x32, 0x04,	0x27, 0x0c, 0x25, 0x10, 0x17, 0x08, 0x15, 0x08,	
	0x12, 0x08, 0x13, 0x18, 0x16, 0x18, 0x17, 0x10, 0x23, 0x20, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04, 0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c,
	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08,
	0x00, 0x08,	0x31, 0x08, 0x27, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08,
	0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 0x32, 0x08, 0x27, 0x08,	0x27, 0x04,	0x25, 0x0c, 0x23, 0x08,	0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	
	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	
	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 
	0x32, 0x08, 0x33, 0x10, 0x35, 0x10, 0x33, 0x20, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x00, 0x08,	
	0x31, 0x08, 0x27, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	
	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 0x32, 0x08, 0x27, 0x08,	0x27, 0x04,	0x25, 0x0c, 0x23, 0x08, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	
	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x23, 0x10, 0x25, 0x10, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x31, 0x08,	0x27, 0x08,	0x25, 0x04,	0x23, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x34
};

unsigned char led_count = 0;
void led_count_up(){
    led_count ++;
    Led_Print(led_count);
}
void led_count_down(){
    led_count --;
    Led_Print(led_count);
}

void music_status_change(){
	if(music_used){
		BeepMusicPlayer_StatusSet(enumBeepMusicPlayer_Pause);
	}
	else if(!beep_used){
		BeepMusicPlayer_StatusSet(enumBeepMusicPlayer_Play);
	}
}

void USBcom_Transmition(){
	USBcom_Write(usbcom_buf);
}

// end debug

int main(){
    Seg_Led_Init();
    Timer0_Init();
    Button_Init();
	USBcom_Init(115200);
	USBcom_Write("hallo c51 usbcom!\r\n");
    Led_Print(0x55);
	AllSeg_Print(hello);

	SetEventCallback(enumEvent_USBcom_Receive, USBcom_Transmition);
	// sys
    while(1) {
		// callback
		if(usbcom_receive) {
			if(CallbackForUSBcomReceive != 0) CallbackForUSBcomReceive();
			usbcom_receive = 0;
		}
	}
}