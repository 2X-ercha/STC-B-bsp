#include <STC15F2K60S2.H>

#include "bsp_global.h"
#include "callback.h"
#include "timer0.h"
#include "seg_led.h"
#include "button.h"
#include "sm.h"
#include "beep.h"

#include <INTRINS.H>
// debug test fun
unsigned char ledtest = 0xf;
unsigned char leftbit = 0;
void waterled(){
    // led流水灯测试
    leftbit = (ledtest >> 7) & 1;
    ledtest <<= 1;
    ledtest |= leftbit;
    Led_Print(ledtest);
}
unsigned char hello[8] = {0x76, 0x79, 0x38, 0x38, 0x5c, 0, 0, 0};
code char number[] = {0x3f,	0x06,	0x5b,	0x4f,	0x66,	0x6d,	0x7d,	0x07,	0x7f,	0x6f,};

code unsigned char testmusic[] = {
	0x27, 0x08, 0x26, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	
	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c,
	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08,
	0x31, 0x08,	0x32, 0x08, 0x27, 0x0c,	0x25, 0x0c, 0x23, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04, 0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x04, 0x32, 0x0c,	0x33, 0x04,
	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08, 0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	
	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x23, 0x10, 0x25, 0x10, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x31, 0x08,
	0x27, 0x08,	0x25, 0x04, 0x23, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x34, 0x25, 0x38, 0x00, 0x28, 0x26, 0x20, 0x26, 0x08,	0x25, 0x08, 0x26, 0x08, 0x27, 0x08, 0x26, 0x20, 0x26, 0x08,	
	0x25, 0x08, 0x26, 0x08, 0x27, 0x08, 0x31, 0x20, 0x31, 0x08, 0x32, 0x08, 0x31, 0x08, 0x27, 0x08, 0x31, 0x08,	0x27, 0x08, 0x26, 0x08, 0x33, 0x08, 0x31, 0x20, 0x26, 0x20, 0x26, 0x08,	0x25, 0x08,
	0x26, 0x08,	0x27, 0x08, 0x26, 0x20, 0x26, 0x08,	0x25, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x10,	0x24, 0x10, 0x27, 0x08,	0x26, 0x08, 0x25, 0x08,	0x26, 0x08, 0x25, 0x18,	0x24, 0x08, 0x24, 0x20,
	0x26, 0x08,	0x26, 0x04, 0x26, 0x08, 0x26, 0x04, 0x26, 0x10, 0x26, 0x08, 0x27, 0x08,	0x26, 0x08, 0x25, 0x10, 0x25, 0x08,	0x33, 0x04,	0x33, 0x1c, 0x33, 0x04,	0x33, 0x04, 0x33, 0x08,	0x32, 0x08,	
	0x31, 0x08,	0x27, 0x08, 0x32, 0x04,	0x31, 0x08,	0x27, 0x0c, 0x26, 0x08, 0x25, 0x0c,	0x25, 0x0c, 0x24, 0x08, 0x26, 0x20, 0x26, 0x08,	0x26, 0x04, 0x26, 0x08, 0x26, 0x04, 0x26, 0x10, 0x26, 0x08,
	0x27, 0x08,	0x27, 0x08, 0x27, 0x10,	0x27, 0x08,	0x25, 0x04,	0x25, 0x14, 0x00, 0x08,	0x25, 0x08, 0x24, 0x10, 0x24, 0x08,	0x23, 0x08, 0x24, 0x08,	0x25, 0x04, 0x26, 0x0c, 0x26, 0x08, 0x26, 0x18,
	0x25, 0x04,	0x24, 0x04, 0x25, 0x20, 0x33, 0x08,	0x00, 0x08, 0x33, 0x08,	0x00, 0x08, 0x33, 0x08, 0x27, 0x08, 0x26, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	
	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	
	0x32, 0x0c, 0x33, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c,
	0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x0c,	0x25, 0x0c, 0x23, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x04, 0x32, 0x0c,	0x33, 0x04, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	
	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x23, 0x10, 0x25, 0x10, 0x27, 0x08,	0x25, 0x04, 0x23, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x34, 0x25, 0x08,	0x26, 0x04,	0x26, 0x54, 0x26, 0x20, 0x26, 0x0c,	
	0x21, 0x0c, 0x23, 0x08, 0x26, 0x20, 0x26, 0x0c,	0x27, 0x0c, 0x31, 0x08, 0x27, 0x20, 0x27, 0x0c,	0x31, 0x0c, 0x32, 0x08, 0x33, 0x20, 0x33, 0x0c,	0x33, 0x0c, 0x34, 0x08, 0x33, 0x0c,	0x31, 0x0c,
	0x26, 0x08, 0x33, 0x0c,	0x31, 0x0c, 0x26, 0x08, 0x33, 0x0c,	0x31, 0x0c, 0x26, 0x08, 0x33, 0x0c,	0x31, 0x0c, 0x26, 0x08, 0x23, 0x40, 0x27, 0x20, 0x22, 0x20, 0x16, 0x0c,	0x21, 0x0c, 0x23, 0x08,
	0x16, 0x20, 0x26, 0x0c,	0x27, 0x0c, 0x31, 0x08, 0x27, 0x0c,	0x25, 0x0c, 0x22, 0x10, 0x25, 0x08, 0x27, 0x08,	0x31, 0x08, 0x33, 0x20,	0x33, 0x0c,	0x33, 0x0c, 0x34, 0x08, 0x33, 0x0c,	0x26, 0x0c,
	0x31, 0x08, 0x33, 0x0c,	0x32, 0x0c, 0x27, 0x08, 0x26, 0x18, 0x35, 0x08,	0x35, 0x08, 0x37, 0x08, 0x36, 0x08,	0x35, 0x08, 0x32, 0x08,	0x32, 0x04,	0x27, 0x0c, 0x25, 0x10, 0x17, 0x08, 0x15, 0x08,	
	0x12, 0x08, 0x13, 0x18, 0x16, 0x18, 0x17, 0x10, 0x23, 0x20, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04, 0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c,
	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08,
	0x00, 0x08,	0x31, 0x08, 0x27, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08,
	0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 0x32, 0x08, 0x27, 0x08,	0x27, 0x04,	0x25, 0x0c, 0x23, 0x08,	0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	
	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	
	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 
	0x32, 0x08, 0x33, 0x10, 0x35, 0x10, 0x33, 0x20, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x00, 0x08,	
	0x31, 0x08, 0x27, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	
	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 0x32, 0x08, 0x27, 0x08,	0x27, 0x04,	0x25, 0x0c, 0x23, 0x08, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	
	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x23, 0x10, 0x25, 0x10, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x31, 0x08,	0x27, 0x08,	0x25, 0x04,	0x23, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x34
};

unsigned char led_count = 0;
void ledcount(){
    led_count ++;
    Led_Print(led_count);
}

void beep_test(){
    Beep_Print(261, 500);
}

void music_play(){
    BeepMusicPlayer_StatusSet(enumBeepMusicPlayer_Play);
}

void music_pause(){
    BeepMusicPlayer_StatusSet(enumBeepMusicPlayer_Pause);
}

void music_stop(){
    BeepMusicPlayer_StatusSet(enumBeepMusicPlayer_Stop);
}

void music_frequency_specctrum_led(){
	unsigned char led_left2, led_right6, led_all = 0;
	if(music_pos == 0){
		Led_Print(0x00);
		OneSeg_Print(6, 0);
		OneSeg_Print(7, 0);
	}
	else{
		led_left2 = (testmusic[music_pos - 2] >> 4) & 0xf;
		led_right6 = testmusic[music_pos - 2] & 0xf;
		switch(led_left2){
			case 2: led_all |= 0x40; break;
			case 3: led_all |= 0xc0; break;
		}
		switch(led_right6){
			case 3: led_all |= 0x10; break;
			case 4: led_all |= 0x18; break;
			case 5: led_all |= 0x1c; break;
			case 6: led_all |= 0x1e; break;
			case 7: led_all |= 0x1f; break;
		}
		Led_Print(led_all);
		OneSeg_Print(6, number[(testmusic[music_pos - 2] >> 4) & 0xf]);
		OneSeg_Print(7, number[testmusic[music_pos - 2] & 0xf]);
	}
}

// end debug

int main(){
    Seg_Led_Init();
    Timer0_Init();
    Button_Init();
    // SM_Init();
    // StepMotor_Init();
    Beep_Init();
    BeepMusicPlayer_MusicInit(0xFB, 140, testmusic, sizeof(testmusic));
	AllSeg_Print(hello);
    Led_Print(0);
    SetEventCallback(enumEvent_key1_Release, music_stop);
    SetEventCallback(enumEvent_key2_Release, music_pause);
    SetEventCallback(enumEvent_Key3_Release, music_play);
    // SetEventCallback(enumEvent_1s, ledcount);
	SetEventCallback(enumEvent_10ms, music_frequency_specctrum_led);

    while(1);
}