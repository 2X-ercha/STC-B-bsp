#include <STC15F2K60S2.H>

#include "bsp_global.h"
#include "callback.h"
#include "timer0.h"
#include "seg_led.h"
#include "button.h"
#include "sm.h"
#include "beep.h"

#include <INTRINS.H>
// debug test fun
unsigned char ledtest = 0xf;
unsigned char leftbit = 0;
void waterled(){
    // led流水灯测试
    leftbit = (ledtest >> 7) & 1;
    ledtest <<= 1;
    ledtest |= leftbit;
    Led_Print(ledtest);
}
unsigned char hello[8] = {0x76, 0x79, 0x38, 0x38, 0x5c, 0, 0, 0};
code char number[] = {0x3f,	0x06,	0x5b,	0x4f,	0x66,	0x6d,	0x7d,	0x07,	0x7f,	0x6f,};

code unsigned char testmusic[] = {
	0x27, 0x08, 0x26, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	
	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c,
	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08,
	0x31, 0x08,	0x32, 0x08, 0x27, 0x0c,	0x25, 0x0c, 0x23, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04, 0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x04, 0x32, 0x0c,	0x33, 0x04,
	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08, 0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	
	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x23, 0x10, 0x25, 0x10, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x31, 0x08,
	0x27, 0x08,	0x25, 0x04, 0x23, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x34, 0x25, 0x38, 0x00, 0x28, 0x26, 0x20, 0x26, 0x08,	0x25, 0x08, 0x26, 0x08, 0x27, 0x08, 0x26, 0x20, 0x26, 0x08,	
	0x25, 0x08, 0x26, 0x08, 0x27, 0x08, 0x31, 0x20, 0x31, 0x08, 0x32, 0x08, 0x31, 0x08, 0x27, 0x08, 0x31, 0x08,	0x27, 0x08, 0x26, 0x08, 0x33, 0x08, 0x31, 0x20, 0x26, 0x20, 0x26, 0x08,	0x25, 0x08,
	0x26, 0x08,	0x27, 0x08, 0x26, 0x20, 0x26, 0x08,	0x25, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x10,	0x24, 0x10, 0x27, 0x08,	0x26, 0x08, 0x25, 0x08,	0x26, 0x08, 0x25, 0x18,	0x24, 0x08, 0x24, 0x20,
	0x26, 0x08,	0x26, 0x04, 0x26, 0x08, 0x26, 0x04, 0x26, 0x10, 0x26, 0x08, 0x27, 0x08,	0x26, 0x08, 0x25, 0x10, 0x25, 0x08,	0x33, 0x04,	0x33, 0x1c, 0x33, 0x04,	0x33, 0x04, 0x33, 0x08,	0x32, 0x08,	
	0x31, 0x08,	0x27, 0x08, 0x32, 0x04,	0x31, 0x08,	0x27, 0x0c, 0x26, 0x08, 0x25, 0x0c,	0x25, 0x0c, 0x24, 0x08, 0x26, 0x20, 0x26, 0x08,	0x26, 0x04, 0x26, 0x08, 0x26, 0x04, 0x26, 0x10, 0x26, 0x08,
	0x27, 0x08,	0x27, 0x08, 0x27, 0x10,	0x27, 0x08,	0x25, 0x04,	0x25, 0x14, 0x00, 0x08,	0x25, 0x08, 0x24, 0x10, 0x24, 0x08,	0x23, 0x08, 0x24, 0x08,	0x25, 0x04, 0x26, 0x0c, 0x26, 0x08, 0x26, 0x18,
	0x25, 0x04,	0x24, 0x04, 0x25, 0x20, 0x33, 0x08,	0x00, 0x08, 0x33, 0x08,	0x00, 0x08, 0x33, 0x08, 0x27, 0x08, 0x26, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	
	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	
	0x32, 0x0c, 0x33, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c,
	0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x0c,	0x25, 0x0c, 0x23, 0x08, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x04, 0x32, 0x0c,	0x33, 0x04, 0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	
	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x23, 0x10, 0x25, 0x10, 0x27, 0x08,	0x25, 0x04, 0x23, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x34, 0x25, 0x08,	0x26, 0x04,	0x26, 0x54, 0x26, 0x20, 0x26, 0x0c,	
	0x21, 0x0c, 0x23, 0x08, 0x26, 0x20, 0x26, 0x0c,	0x27, 0x0c, 0x31, 0x08, 0x27, 0x20, 0x27, 0x0c,	0x31, 0x0c, 0x32, 0x08, 0x33, 0x20, 0x33, 0x0c,	0x33, 0x0c, 0x34, 0x08, 0x33, 0x0c,	0x31, 0x0c,
	0x26, 0x08, 0x33, 0x0c,	0x31, 0x0c, 0x26, 0x08, 0x33, 0x0c,	0x31, 0x0c, 0x26, 0x08, 0x33, 0x0c,	0x31, 0x0c, 0x26, 0x08, 0x23, 0x40, 0x27, 0x20, 0x22, 0x20, 0x16, 0x0c,	0x21, 0x0c, 0x23, 0x08,
	0x16, 0x20, 0x26, 0x0c,	0x27, 0x0c, 0x31, 0x08, 0x27, 0x0c,	0x25, 0x0c, 0x22, 0x10, 0x25, 0x08, 0x27, 0x08,	0x31, 0x08, 0x33, 0x20,	0x33, 0x0c,	0x33, 0x0c, 0x34, 0x08, 0x33, 0x0c,	0x26, 0x0c,
	0x31, 0x08, 0x33, 0x0c,	0x32, 0x0c, 0x27, 0x08, 0x26, 0x18, 0x35, 0x08,	0x35, 0x08, 0x37, 0x08, 0x36, 0x08,	0x35, 0x08, 0x32, 0x08,	0x32, 0x04,	0x27, 0x0c, 0x25, 0x10, 0x17, 0x08, 0x15, 0x08,	
	0x12, 0x08, 0x13, 0x18, 0x16, 0x18, 0x17, 0x10, 0x23, 0x20, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04, 0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c,
	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08,
	0x00, 0x08,	0x31, 0x08, 0x27, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08,
	0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 0x32, 0x08, 0x27, 0x08,	0x27, 0x04,	0x25, 0x0c, 0x23, 0x08,	0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	
	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	
	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 
	0x32, 0x08, 0x33, 0x10, 0x35, 0x10, 0x33, 0x20, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x00, 0x08,	
	0x31, 0x08, 0x27, 0x08, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	
	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 0x32, 0x08, 0x27, 0x08,	0x27, 0x04,	0x25, 0x0c, 0x23, 0x08, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08,
	0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x34, 0x10, 0x32, 0x10, 0x32, 0x0c,	0x32, 0x0c, 0x33, 0x08, 0x00, 0x08,	0x31, 0x08, 0x27, 0x08,	0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	
	0x26, 0x04,	0x26, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x26, 0x08, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08,	0x32, 0x08, 0x26, 0x20, 0x26, 0x08,	0x27, 0x08, 0x31, 0x08, 0x32, 0x08,
	0x27, 0x10, 0x25, 0x10, 0x23, 0x10, 0x25, 0x10, 0x25, 0x08,	0x26, 0x04,	0x26, 0x0c, 0x31, 0x08,	0x27, 0x08,	0x25, 0x04,	0x23, 0x0c, 0x25, 0x08, 0x25, 0x08,	0x26, 0x04,	0x26, 0x34
};

unsigned char led_count = 0;
void led_count_up(){
    led_count ++;
    Led_Print(led_count);
}
void led_count_down(){
    led_count --;
    Led_Print(led_count);
}

int beeptone = 0;
void segprinttone(){
	if(beeptone >= 1000){
		OneSeg_Print(0, number[beeptone/1000]);
		OneSeg_Print(1, number[beeptone/100%10]);
		OneSeg_Print(2, number[beeptone/10%10]);
		OneSeg_Print(3, number[beeptone%10]);
		OneSeg_Print(4, 0);
		OneSeg_Print(5, 0x76);
		OneSeg_Print(6, 0x59);
	}
	else if(beeptone > 0){
		OneSeg_Print(0, number[beeptone/100]);
		OneSeg_Print(1, number[beeptone/10%10]);
		OneSeg_Print(2, number[beeptone%10]);
		OneSeg_Print(3, 0);
		OneSeg_Print(4, 0x76);
		OneSeg_Print(5, 0x59);
		OneSeg_Print(6, 0);
	}
	else{
		OneSeg_Print(0, number[0]);
		OneSeg_Print(1, 0);
		OneSeg_Print(2, 0x76);
		OneSeg_Print(3, 0x59);
		OneSeg_Print(4, 0);
		OneSeg_Print(5, 0);
		OneSeg_Print(6, 0);
	}
}

void music_status_change(){
	if(music_used){
		BeepMusicPlayer_StatusSet(enumBeepMusicPlayer_Pause);
	}
	else if(!beep_used){
		BeepMusicPlayer_StatusSet(enumBeepMusicPlayer_Play);
	}
}

void beep_tone_up(){
	if((beeptone < 2000) && !music_used){beeptone += 200; Beep_Print(beeptone, 500);}
	segprinttone();
	StepMotor_Speed_Set(beeptone >> 3);
}

void beep_tone_down(){
	if((beeptone >= 200) && !music_used){beeptone -= 200; Beep_Print(beeptone, 500);}
	segprinttone();
	StepMotor_Speed_Set(beeptone >> 3);
}

// end debug

int main(){
    Seg_Led_Init();
    Timer0_Init();
    Button_Init();
    // SM_Init();
    StepMotor_Init();
    Beep_Init();
    BeepMusicPlayer_MusicInit(0xFB, 140, testmusic, sizeof(testmusic));
	segprinttone();
	// AllSeg_Print(hello);
    Led_Print(0);
    SetEventCallback(enumEvent_key1_Release, beep_tone_down);
    SetEventCallback(enumEvent_key2_Release, beep_tone_up);
    SetEventCallback(enumEvent_Key3_Release, music_status_change);

	SetEventCallback(enumEvent_NavKet_IsTop, led_count_up);
	SetEventCallback(enumEvent_NavKet_IsDown, led_count_down);

    while(1);
}