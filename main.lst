C51 COMPILER V9.51   MAIN                                                                  10/13/2022 11:05:22 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\dist\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE src\main.c BROWSE DEBUG OBJECTEXTEND PRINT(.\main.lst) TABS(2) OBJECT(.\dis
                    -t\main.obj)

line level    source

   1          #include <STC15F2K60S2.H>
   2          #include <math.h>
   3          #include <intrins.h>    // å›ºæœ‰å‡½æ•°
   4          #include <absacc.h>     // è®¿é—®ç‰¹æ®ŠåŠŸèƒ½å¯„å­˜å™¨ï¼ˆå¯èƒ½ç”¨ä¸åˆ°ï¼‰
   5          #include <stdio.h>      // åŠ¨æ€åˆ†é…å†…å­˜å‡½æ•°
   6          #include <stdlib.h>     // æ ‡å‡†åº“
   7          
   8          // ä»¥ä¸Šç”¨ä¸ç”¨çš„åˆ°ä¸çŸ¥é“ï¼Œåæ­£å…ˆæ”¾ç€
   9          
  10          // seg & led å¯„å­˜å™¨å¤‡æ³¨è¯´æ˜
  11          /*
  12           * P0: P07 - P00 é«˜ç”µå¹³æœ‰æ•ˆ
  13           * åŠŸèƒ½1ï¼šæ•°ç ç®¡å•ä¸ªæ®µé€‰
  14           *      ç®¡è„šç¼–ç ä½ï¼šï¼ˆå°æ•°ç‚¹ä¸º8)
  15           *     ----    0
  16           *    |    |     5   1
  17           *     ----      6
  18           *    |    |     4   2
  19           *     ---- -    5   7
  20           *      ç®¡è„šå¯¹åº”å¯„å­˜å™¨å³ä¸º P00 - P07
  21           * åŠŸèƒ½2: ledç¯é€‰æ‹©ï¼ˆåˆšå¥½8ä¸ªï¼Œä»å·¦å¾€å³ P07 - P00 ï¼‰
  22           * 
  23           * P2:
  24           *  P22 - P20
  25           *      é€‰æ‹©ç¬¬nä¸ªæ•°ç ç®¡ç‚¹äº®ï¼ˆé«˜é€Ÿå¾ªç¯æ¥å®Œæˆè§†è§‰æš‚ç•™ï¼‰
  26           *  P23 ï¼ˆæ³¨ E3 è¿æ¥åˆ°æ•°ç ç®¡ä¸­ï¼‰
  27           *      è®¾ä¸º0åˆ™æ•°ç ç®¡æ˜¾ç¤ºï¼Œè®¾ä¸º1åˆ™ledæ˜¾ç¤º
  28           */
  29          
  30          /*
  31           * æ¨æŒ½ç­‰å¯„å­˜å™¨åˆå§‹åŒ–ç›¸å…³
  32           * P0: ï¼ˆèŠ¯ç‰‡æ•°æ®æ‰‹å†Œ p324ï¼‰
  33           *  ä¾‹å¦‚ï¼šï¼ˆ00ï¼šå‡†åŒå‘å£    01ï¼šæ¨æŒ½è¾“å‡º    10ï¼šä»…ä¸ºè¾“å…¥    11ï¼šå¼€æ¼ï¼ˆå¯è¯»å¯å†™ï
             -¼‰
  34           *          P07     P06     P05     P04     P03     P02     P01     P00
  35           *  P0M1:   1       0       1       0       0       0       0       0
  36           *  P0M0:   1       1       0       0       0       0       0       0
  37           *          å¼€æ¼    æ¨æŒ½    è¾“å…¥     å‡†åŒå‘    
  38           * 
  39           * P2: ï¼ˆèŠ¯ç‰‡æ•°æ®æ‰‹å†Œ p323ï¼‰
  40           *  åŒä¸Š
  41           * è¿™é‡Œå¯¹äºsegå’Œledè€Œè¨€ï¼Œæ˜¾ç„¶åªéœ€è¦è®¾ä¸ºæ¨æŒ½è¾“å‡ºå³å¯
  42           */
  43          
  44          unsigned char seg_display_buf[8] = {0,0,0,0,0,0,0,0};    // å­˜å‚¨å„ä¸ªæ•°ç ç®¡æ˜¾ç¤ºä½çš„å…·ä½“å€¼
  45          unsigned char led_display_buf = 0;                       // å­˜å‚¨ledæ˜¾ç¤ºå€¼
  46          
  47          unsigned char display_pos = 0;
  48          
  49          void Seg_Led_Init(){
  50   1          // P0ã€P2å£å…¨éƒ¨è®¾ä¸ºæ¨æŒ½è¾“å‡º
  51   1          P0M1 = 0x00;
  52   1          P0M0 = 0xff;
  53   1          P2M1 &= 0xf0;
C51 COMPILER V9.51   MAIN                                                                  10/13/2022 11:05:22 PAGE 2   

  54   1          P2M0 |= 0x0f;
  55   1      }
  56          
  57          void OneSeg_Print(unsigned char num, unsigned char displaychar){
  58   1          /*
  59   1           * description:
  60   1           *  å•å­—ç¬¦æ•°ç ç®¡æ˜¾ç¤ºä¿®æ”¹
  61   1           * parameter:
  62   1           *  num: ä¿®æ”¹çš„ç›®æ ‡æ•°ç ç®¡ç¼–å·ï¼Œä»å·¦åˆ°å³ä¾æ¬¡ä¸º 0-7
  63   1           *  displaychar: ä¿®æ”¹åæ˜¾ç¤ºçš„å­—ç¬¦ 
  64   1           */
  65   1          seg_display_buf[num] = displaychar;
  66   1      }
  67          
  68          void AllSeg_Print(unsigned char* displaychars){
  69   1          /*
  70   1           * description:
  71   1           *  8ä½æ•°ç ç®¡å…¨æ˜¾ç¤ºä¿®æ”¹
  72   1           * parameter:
  73   1           *  displaychars: æ˜¾ç¤ºå­—ç¬¦çš„ç¼–ç æ•°ç»„ï¼Œé•¿åº¦ä¸º8
  74   1           */
  75   1          seg_display_buf[7] = displaychars[7];
  76   1          seg_display_buf[6] = displaychars[6];
  77   1          seg_display_buf[5] = displaychars[5];
  78   1          seg_display_buf[4] = displaychars[4];
  79   1          seg_display_buf[3] = displaychars[3];
  80   1          seg_display_buf[2] = displaychars[2];
  81   1          seg_display_buf[1] = displaychars[1];
  82   1          seg_display_buf[0] = displaychars[0];
  83   1      }
  84          
  85          void Led_Print(unsigned char displaychar){
  86   1          led_display_buf = displaychar;
  87   1      }
  88          
  89          void display_pos_next(){
  90   1          /* è¯¥å‡½æ•°åº”è¯¥è¢«å†™å…¥è°ƒåº¦ï¼Œä¸å¯¹å¤–æä¾›api */
  91   1          if(display_pos < 7)
  92   1              display_pos ++;
  93   1          else
  94   1              display_pos = 0;
  95   1      }
  96          
  97          void segled_display(){
  98   1          P23 = ~P23;
  99   1          if(P23 == 0){
 100   2              P0 = seg_display_buf[display_pos];
 101   2              P20 = display_pos & 0x1;
 102   2              P21 = (display_pos & 0x2) >> 1;
 103   2              P22 = (display_pos & 0x4) >> 2;
 104   2          }
 105   1          else{
 106   2              P0 = led_display_buf;
 107   2          }
 108   1      }
 109          
 110          #define MAIN_Fosc       11059200L
 111          #define Main_Fosc_KHZ (MAIN_Fosc / 1000)
 112          #define TIMESLICE_MS  1
 113          #define Fosc_1ms        (65536 - MAIN_Fosc*TIMESLICE_MS/12/1000)
 114          
 115          unsigned int timer_count = 0;
C51 COMPILER V9.51   MAIN                                                                  10/13/2022 11:05:22 PAGE 3   

 116          
 117          void Timer0_Init(){
 118   1          // p498
 119   1          timer_count = 0;
 120   1          TR0 = 0;    // åœæ­¢timer0
 121   1          TMOD &= 0xF0;   // timer0 modeè®¾ç½®ä¸º(xxxx0000b, .3:0 æ‰“å¼€å®šæ—¶/è®¡æ•°å™¨ .2:0 é€‰æ‹©å®šæ—¶æ¨¡å¼
             - .1-0:00 16ä½è‡ªåŠ¨é‡è£…å®šæ—¶å™¨)
 122   1          AUXR &= 0x7F;   // å®šæ—¶å™¨0ç”¨ä¼ ç»Ÿ8051é€Ÿåº¦ï¼Œ12åˆ†é¢‘ï¼ˆï¼Ÿï¼‰
 123   1          TH0 = (Fosc_1ms & 0xff00) >> 8;  TL0 = Fosc_1ms & 0xff;     // è®¾ç½®å®šæ—¶å™¨
 124   1          ET0 = EA = 1;   // å¯ç”¨timer0ä¸­æ–­
 125   1        PT0 = 1;    // è®¾ç½®é«˜ä¼˜å…ˆçº§ï¼ˆåœ¨C51ä¸­timer0æœ¬èº«ä¼˜å…ˆçº§ä¸ºç¬¬äºŒï¼Œè®¾ä¸º1åŸºæœ¬ä¸Šæ˜¯æœ€é«˜äº†ï
             -¼‰
 126   1        TR0 = 1;        // å¯ç”¨timer0
 127   1      }
 128          
 129          #define enumEvent_1ms 0
 130          #define enumEvent_10ms 1
 131          #define enumEvent_100ms 2
 132          #define enumEvent_1s 3
 133          typedef void (*EventCallback)(void);
 134          EventCallback CallbackFor1ms = NULL;
 135          EventCallback CallbackFor10ms = NULL;
 136          EventCallback CallbackFor100ms = NULL;
 137          EventCallback CallbackFor1s = NULL;
 138          
 139          void SetEventCallback(unsigned char event_interrupt_api, void (*fp)()){
 140   1          switch(event_interrupt_api){
 141   2              case 0: CallbackFor1ms = fp; break;
 142   2              case 1: CallbackFor10ms = fp; break;
 143   2              case 2: CallbackFor100ms = fp; break;
 144   2              case 3: CallbackFor1s = fp; break;
 145   2              default: break;
 146   2          }
 147   1      }
 148          
 149          void Timer0_Rountine() interrupt 1{
 150   1          if(P23 == 1)
 151   1              display_pos_next();
 152   1          segled_display();
 153   1      
 154   1          if(CallbackFor1ms != NULL)CallbackFor1ms();   
 155   1          if(timer_count % 10 == 0 && CallbackFor10ms != NULL){CallbackFor10ms();}
 156   1          if(timer_count % 100 == 0 && CallbackFor100ms != NULL){CallbackFor100ms();}
 157   1          if(timer_count == 0 && CallbackFor1s != NULL){CallbackFor1s();}
 158   1      
 159   1          timer_count ++;
 160   1          if(timer_count >= 1000)
 161   1              timer_count = 0;
 162   1          // TH0 = (Fosc_1ms & 0xff00) >> 8;  TL0 = Fosc_1ms & 0xff;     // é‡ç½®å®šæ—¶å™¨ï¼ˆ16ä½è‡ªåŠ¨é‡è½½ä
             -º†ï¼Œä¸éœ€è¦ æ–‡æ¡£P499
 163   1      }
 164          
 165          // debug
 166          unsigned char ledtest = 0x0f;
 167          unsigned char leftbit = 0;
 168          void waterled(){
 169   1          // æµæ°´ç¯æµ‹è¯•
 170   1              leftbit = (ledtest >> 7) & 1;
 171   1              ledtest <<= 1;
 172   1              ledtest |= leftbit;
 173   1              Led_Print(ledtest);
 174   1      }
C51 COMPILER V9.51   MAIN                                                                  10/13/2022 11:05:22 PAGE 4   

 175          unsigned char hello[8] = {0x76, 0x79, 0x38, 0x38, 0x5c, 0, 0, 0};
 176          
 177          int main(){
 178   1          Seg_Led_Init();
 179   1          Timer0_Init();
 180   1          AllSeg_Print(hello);
 181   1          Led_Print(0);
 182   1      
 183   1          // CallbackFor1s = waterled;
 184   1          SetEventCallback(enumEvent_100ms, waterled);
 185   1      
 186   1          while(1);
 187   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    456    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     34    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
